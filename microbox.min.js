!function(a,b){"object"==typeof exports?module.exports=b(require("umodel"),require("u")):"function"==typeof define&&define.amd?define("microbox",["umodel","u"],b):a.microbox=b(a.umodel,a.u)}(this,function(a,b){var c,d,e,f;return f=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(e="",q=a.images,k=0,n=q.length;n>k;k++)j=q[k],e+='<img src="'+j+'" alt="" />';for(d="",r=a.captions,h=l=0,o=r.length;o>l;h=++l)c=r[h],c&&(d+='<div class="caption" microbox-caption="'+h+'">\n	<span class="microbox-button" microbox-trigger-caption>i</span>\n	'+c+"\n</div>");if(a.images.length>1){for(g="",s=a.images,h=m=0,p=s.length;p>m;h=++m)f=s[h],g+='<li microbox-trigger-set="'+b+'" microbox-trigger-index="'+h+'">'+(h+1)+"</li>";i='<ul class="microbox-pager">\n	<li class="microbox-counts">'+(a.active+1)+"/"+a.images.length+'</li>\n	<li microbox-trigger-prev microbox-trigger-set="'+b+'">&#9656;</li>\n	'+g+'\n	<li microbox-trigger-next microbox-trigger-set="'+b+'">&#9656;</li>\n</ul>'}else i="";return'<span class="microbox-button microbox-close" microbox-close>&times;</span>\n<div class="inner">\n	'+e+"\n</div>\n"+d+"\n"+i},c=function(a,b,c){return b>a?a=b:a>c&&(a=c),a},d={27:"esc",37:"left",39:"right",65:"a",68:"d"},e=function(){var e,g,h,i,j,k,l,m,n,o;return g=-1,k=new a({visible:null,sets:{}}),h=function(){for(;!(++g in k.get("sets"));)return g},o=function(a,d,e){var f,g,h,i,j,l;return null==d&&(d=0),null==a?(console.error("microbox.toggle expects a set ID, given '"+a+"'"),!1):(j=k.get("sets/"+a),i=j.images.length-1,h=j.element,null==j?(console.error("microbox.toggle passed an invalid set id '"+a+"'"),!1):(d=c(+d,0,i),l=e===!0?"add":e===!1?"remove":"toggle",b.classList[l](h,"visible"),b.classList.contains(h,"visible")?(g=j.components,b.each(g.images,function(a){return b.classList.remove(a,"visible")}),b.classList.add(g.images[d],"visible"),g.counts.innerHTML=""+(d+1)+"/"+j.images.length,b.each(g.pagerItems,function(a){return b.classList.remove(a,"active")}),b.classList.add(g.pagerItems[d],"active"),l=0===d?"add":"remove",b.classList[l](g.prev,"disabled"),l=d===i?"add":"remove",b.classList[l](g.next,"disabled"),b.each(g.captions,function(a){return b.classList.add(a,"hide"),b.classList.remove(a,"active"),a.style.top=""}),g.pager.style.bottom="",f=g.captions[d],f&&b.classList.remove(f,"hide"),j.active=d,k.set("visible",j)):k.set("visible",null)))},e=function(a,b){var c,d;return d=k.get("sets/"+a),c=d.triggers.indexOf(b),b.addEventListener("click",function(b){return b.preventDefault(),o(a,c)})},j=function(){var a;return a=document.querySelectorAll('a[href][rel^="lightbox"]'),b.each(a,function(a){var b,c,d,f,g,i;return b=a.getAttribute("href"),f=a.getAttribute("rel"),i=a.getAttribute("title")||"",d=f.split("["),c=d[1]?d[1].slice(0,-1):h(),g=k.get("sets/"+c),g?g.triggers.indexOf(a)<0&&(g.captions.push(i),g.images.push(b),g.triggers.push(a)):k.set("sets/"+c,{captions:[i],images:[b],triggers:[a],active:0,id:c}),e(c,a)}),b.each(k.get("sets"),function(a,c){var d,e;return e=f(a,c),d=document.createElement("div"),d.className="microbox",d.innerHTML=e,document.body.appendChild(d),a=k.get("sets/"+c),a.element=d,a.components={captions:[],counts:d.querySelector(".microbox-counts"),images:d.querySelectorAll("img"),pager:d.querySelector(".microbox-pager"),pagerItems:d.querySelectorAll("[microbox-trigger-index]"),next:d.querySelector("[microbox-trigger-next]"),prev:d.querySelector("[microbox-trigger-prev]")},b.each(d.querySelectorAll("[microbox-caption]"),function(b){return c=+b.getAttribute("microbox-caption"),a.components.captions[c]=b})})},document.addEventListener("click",function(a){var c,d,e,f,g,h,j,k,n;return k=a.target,b.classList.contains(k,"inner")||k.hasAttribute("microbox-close")?i():k.hasAttribute("microbox-trigger-index")&&k.hasAttribute("microbox-trigger-set")?(j=k.getAttribute("microbox-trigger-set"),e=k.getAttribute("microbox-trigger-index"),o(j,e,!0)):k.hasAttribute("microbox-trigger-next")||k.hasAttribute("microbox-trigger-prev")?k.hasAttribute("microbox-trigger-next")?l():m():k.hasAttribute("microbox-trigger-caption")?(c=k.parentNode,d=c.offsetHeight,h=window.innerHeight,n=c.style.top,g=c.parentNode.querySelector(".microbox-pager"),n&&parseInt(n,10)!==h?(b.classList.remove(c,"active"),c.style.top="",g.style.bottom=""):(f=h-d,c.style.top=""+f+"px",b.classList.add(c,"active"),g.style.bottom=""+(d+10)+"px")):void 0}),window.addEventListener("keydown",function(a){var b,c;if(b=d[a.keyCode],c=k.get("visible"),b&&c)switch(b){case"esc":return i();case"left":case"a":return m();case"right":case"d":return l()}}),i=function(){var a,b,c;return c=k.get("visible"),c?(a=c.id,b=k.get("sets/"+a+"/active"),o(a,null,!1)):console.error("microbox.hide() can only be called when a set is visible")},n=function(a){var c;return k.get("sets/"+a)?o(a,null,!0):(c=b.keys(k.get("sets")),console.error("Set with ID '"+a+"' does not exist. Available sets: ",c))},l=function(){var a,b,c;return c=k.get("visible"),c?(a=c.id,b=k.get("sets/"+a+"/active"),o(a,++b,!0)):console.error("microbox.next() can only be called when a set is visible")},m=function(){var a,b,c;return c=k.get("visible"),c?(a=c.id,b=k.get("sets/"+a+"/active"),o(a,--b,!0)):console.error("microbox.prev() can only be called when a set is visible")},j(),{init:j,next:l,prev:m,hide:i,show:n}}()});